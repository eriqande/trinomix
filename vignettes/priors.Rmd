---
title: "Prior sensitivity for overdispersion"
author: ""
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Prior sensitivity for overdispersion}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set-knitr-options, cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library("knitr")
opts_chunk$set(message = FALSE, warning=FALSE, fig.width = 5.5)
```

Let's load the necessary packages:

```{r, message=FALSE, warning=FALSE}
library(trinomix)
```

## Fish stomach contents example

We will demonstrate this sensitivity with the cod stomach contents data included with the package. 
```{r}
data(coddiet)
data_matrix = coddiet[,names(coddiet)%in%c("Year","Season")==FALSE]
```

We'll ignore the important covariates (year, season) and just treat all observations (rows) as replicates. 

The overdispersion parameter $\theta$ is assigned a prior so that $1/\theta \sim Cauchy(0,\sigma)$. Because $\theta$ has to be positive, this prior is also assigned a lower bound of 0 (half-Cauchy). 

Using our cod diet data, we can fit the model with several different values of the prior standard deviation, and look at the prior versus posterior draws for $\theta$. First, we'll use the default prior of $\sigma=5$.

```{r}
set.seed(123)
fit_1 <- fit_trinomix(data_matrix = as.matrix(data_matrix),
                      overdispersion = TRUE,
                      overdispersion_sd = 5,
                      chains=1,
                      iter=2000)
```

Now we can compare the prior and posterior distributions; because these are skewed, we'll show them in log-space. 

```{r}
prior = data.frame("value" = fit_1$overdispersion_prior,
                   "dist"="prior")
post = data.frame("value" = rstan::extract(fit_1$model,"theta")$theta,
                  "dist"="post")

hist(log(fit_1$overdispersion_prior), breaks=seq(-20,20,length.out=100), col=rgb(0,0,1,1/4), xlim=c(-10,10),ylim=c(0,1000), main="Posterior (pink) and prior (blue)", xlab=expression(theta))
hist(log(rstan::extract(fit_1$model,"theta")$theta),breaks=seq(-20,20,length.out=100), col=rgb(1,0,0,1/4), add=T)

```

Next we can try re-fitting the model with a lot more informative (smaller) value of $\sigma$. We can calculate the percent overlap across each iteration to quantify similarity between prior and posterior.

```{r}
df = data.frame("sd"=exp(seq(log(0.001),log(0.1),length.out=10)),overlap=0)
for(i in 1:nrow(df)) {
  fit_1 <- fit_trinomix(data_matrix = as.matrix(data_matrix),
                      overdispersion = TRUE,
                      overdispersion_sd = df$sd[i],
                      chains=1,
                      iter=2000)
  df$overlap[i] = length(which(fit_1$overdispersion_prior < max(rstan::extract(fit_1$model,"theta")$theta))) / length(fit_1$overdispersion_prior)
}
plot(df$sd,df$overlap, xlab="Prior SD", ylab="% Overlap",main="",type="b")
```



