<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting models with trinomix • trinomix</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Fitting models with trinomix">
<meta property="og:description" content="trinomix">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">trinomix</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fitting.html">Fitting models with trinomix</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nwfsc-cb/trinomix/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="fitting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting models with trinomix</h1>
                        <h4 class="author">Eric J. Ward</h4>
            
            <h4 class="date">2021-09-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nwfsc-cb/trinomix/blob/master/vignettes/fitting.Rmd"><code>vignettes/fitting.Rmd</code></a></small>
      <div class="hidden name"><code>fitting.Rmd</code></div>

    </div>

    
    
<p>Let’s load the necessary packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://nwfsc-cb.github.io/trinomix/">trinomix</a></span><span class="op">)</span></code></pre></div>
<div id="fish-stomach-contents-example" class="section level2">
<h2 class="hasAnchor">
<a href="#fish-stomach-contents-example" class="anchor"></a>Fish stomach contents example</h2>
<p>Here, we will use a dataset of cod stomachs on the Faroe Bank, published in</p>
<p><em>Magnussen, E. 2011. Food and feeding habits of cod (Gadus morhua) on the Faroe Bank. – ICES Journal of Marine Science, 68: 1909–1917.</em></p>
<p>The data are also included with our package, and represent a dataframe with observations on rows (stratified by year and season) and prey items across columns.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">coddiet</span><span class="op">)</span></code></pre></div>
<p>We need to split the dataset into 2 matrices, one representing the design matrix for the observations (‘Year’ and ‘Season’) and the other representing the data matrix of observed biomass per sample - prey item. If all rows are considered replicate observations, there’s no need to create a design matrix - but we can test for the effects of Season and Year.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_matrix</span> <span class="op">=</span> <span class="va">coddiet</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">coddiet</span><span class="op">)</span><span class="op">%in%</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"Season"</span><span class="op">)</span><span class="op">==</span><span class="cn">TRUE</span><span class="op">]</span>
<span class="va">data_matrix</span> <span class="op">=</span> <span class="va">coddiet</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">coddiet</span><span class="op">)</span><span class="op">%in%</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"Season"</span><span class="op">)</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">]</span></code></pre></div>
<div id="overdispersion-or-not" class="section level3">
<h3 class="hasAnchor">
<a href="#overdispersion-or-not" class="anchor"></a>Overdispersion or not?</h3>
<p>One optional feature of the model is to include overdispersion in the calculations of the 3 probabilities for each cell. Including overdispersion is generally only advised with replicated data or shared information – and may fit heterogeneous datasets with lots of 0s better than the model without overdispersion. For the cod diet data, we’ll include overdispersion because of poor MCMC sampling without it.</p>
</div>
<div id="model-selection" class="section level3">
<h3 class="hasAnchor">
<a href="#model-selection" class="anchor"></a>Model selection</h3>
<p>Next, we can test some hypotheses about how the data are structured. We’ll create the following models (1) a model with all observations as replicate samples, (2) a model with only seasonal effects, (3) a model with only differences by year, and (4) a model with both year and season. Both year and season are treated as factors here – but continuous covariates can also be included.</p>
<p>Note that for fitting, the data_matrix should be a matrix, but the design_matrix should be a data frame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_matrix</span><span class="op">$</span><span class="va">Season</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">design_matrix</span><span class="op">$</span><span class="va">Season</span><span class="op">)</span>
<span class="va">design_matrix</span><span class="op">$</span><span class="va">Year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">design_matrix</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>
<span class="va">design_matrix</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fl">1</span> <span class="co"># dummy variable</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">fit_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_trinomix.html">fit_trinomix</a></span><span class="op">(</span>data_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,
                      overdispersion <span class="op">=</span> <span class="cn">TRUE</span>,
                      chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span>

<span class="va">fit_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_trinomix.html">fit_trinomix</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">Season</span>, 
                      design_matrix <span class="op">=</span> <span class="va">design_matrix</span>, 
                      data_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,
                      overdispersion <span class="op">=</span> <span class="cn">TRUE</span>,
                      chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span>

<span class="va">fit_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_trinomix.html">fit_trinomix</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">Year</span>, 
                      design_matrix <span class="op">=</span> <span class="va">design_matrix</span>, 
                      data_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,
                      overdispersion <span class="op">=</span> <span class="cn">TRUE</span>,
                      chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span>

<span class="va">fit_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_trinomix.html">fit_trinomix</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">Year</span> <span class="op">+</span> <span class="va">Season</span>, 
                      design_matrix <span class="op">=</span> <span class="va">design_matrix</span>, 
                      data_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,
                      overdispersion <span class="op">=</span> <span class="cn">TRUE</span>,
                      chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>To compare models, we could use criteria like LOOIC in the loo package – this is accessible by calling</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">loo_1</span> <span class="op">=</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit_1</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
<span class="va">loo_2</span> <span class="op">=</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit_2</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
<span class="va">loo_3</span> <span class="op">=</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit_3</span><span class="op">$</span><span class="va">model</span><span class="op">)</span>
<span class="va">loo_4</span> <span class="op">=</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit_4</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></code></pre></div>
<p>For our example, the LOOIC from the model with Season and Year is lowest (2584.9) indicating the most support over the base model (2879.7), model with Season only (2892.4), and model with Year only (2637.2). Two words of caution for this application are (1) the standard errors of the LOOIC estimates are all in the 120-160 range, so many of the models are within +/- 1 SE of each other and (2) the Pareto-k diagnostic values fall into the ‘bad’ category for about 20% of the data points. There’s a couple solutions for this, including more MCMC sampling, and using PSIS smooth sampling</p>
</div>
<div id="summarizing-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#summarizing-estimates" class="anchor"></a>Summarizing estimates</h3>
<p>We include several helper functions for processing output into more manageable data frames. First, we can extract the predicted point estimates (and uncertainty intervals) around proportions,</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_trinomix.html">fit_trinomix</a></span><span class="op">(</span>data_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>, 
                      chains<span class="op">=</span><span class="fl">1</span>,
                      iter<span class="op">=</span><span class="fl">500</span>,
                      overdispersion <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL 'dirichreg' NOW (CHAIN 1).
## Chain 1: Rejecting initial value:
## Chain 1:   Error evaluating the log probability at the initial value.
## Chain 1: Exception: validate transformed params: p_zero[1] is inf, but must be less than or equal to 1  (in 'model_dirichreg' at line 66)
## 
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000452 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 4.52 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:   1 / 500 [  0%]  (Warmup)
## Chain 1: Iteration:  50 / 500 [ 10%]  (Warmup)
## Chain 1: Iteration: 100 / 500 [ 20%]  (Warmup)
## Chain 1: Iteration: 150 / 500 [ 30%]  (Warmup)
## Chain 1: Iteration: 200 / 500 [ 40%]  (Warmup)
## Chain 1: Iteration: 250 / 500 [ 50%]  (Warmup)
## Chain 1: Iteration: 251 / 500 [ 50%]  (Sampling)
## Chain 1: Iteration: 300 / 500 [ 60%]  (Sampling)
## Chain 1: Iteration: 350 / 500 [ 70%]  (Sampling)
## Chain 1: Iteration: 400 / 500 [ 80%]  (Sampling)
## Chain 1: Iteration: 450 / 500 [ 90%]  (Sampling)
## Chain 1: Iteration: 500 / 500 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 35.6677 seconds (Warm-up)
## Chain 1:                8.48355 seconds (Sampling)
## Chain 1:                44.1513 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted_vals</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_fitted.html">get_fitted</a></span><span class="op">(</span><span class="va">fit_1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fitted_vals</span><span class="op">)</span></code></pre></div>
<pre><code>##   obs group      mean     median         lo         hi
## 1   1     1 0.0201379 0.01970247 0.01077936 0.03204521
## 2   2     1 0.0201379 0.01970247 0.01077936 0.03204521
## 3   3     1 0.0201379 0.01970247 0.01077936 0.03204521
## 4   4     1 0.0201379 0.01970247 0.01077936 0.03204521
## 5   5     1 0.0201379 0.01970247 0.01077936 0.03204521
## 6   6     1 0.0201379 0.01970247 0.01077936 0.03204521</code></pre>
<p>Second, we can return all parameters (including betas for coefficients and theta, the overdispersion term)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted_vals</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_pars.html">get_pars</a></span><span class="op">(</span><span class="va">fit_1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fitted_vals</span><span class="op">$</span><span class="va">betas</span><span class="op">)</span></code></pre></div>
<pre><code>##   group cov         par       mean    median        lo         hi
## 1     1   1 (Intercept) -1.0075216 -1.002758 -1.567037 -0.4424480
## 2     2   1 (Intercept) -1.0320721 -1.012814 -1.585283 -0.5237584
## 3     3   1 (Intercept) -1.0610188 -1.016996 -1.888822 -0.4911196
## 4     4   1 (Intercept) -1.2229597 -1.218529 -1.884897 -0.5879951
## 5     5   1 (Intercept) -1.3927539 -1.407770 -2.059366 -0.7255260
## 6     6   1 (Intercept) -0.8773785 -0.876527 -1.371053 -0.3876807</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Eric Ward, Alex Jensen, Ryan Kelly, Ole Shelton, Will Satterthwaite.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
